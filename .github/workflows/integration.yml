name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  python-integration:
    name: Python Integration Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-asyncio pytest-cov

      - name: Run basic integration tests
        run: |
          pytest tests/integration/test_basic_integration.py -v --tb=short

      - name: Run HTTP transport tests
        run: |
          pytest tests/integration/test_transport_http.py -v --tb=short -k "not slow and not skip"

      - name: Run WebSocket transport tests
        run: |
          pytest tests/integration/test_transport_websocket.py -v --tb=short -k "not slow and not skip"

      - name: Run gRPC transport tests
        run: |
          pytest tests/integration/test_transport_grpc.py -v --tb=short -k "not slow and not skip"

      - name: Run middleware consistency tests
        run: |
          pytest tests/integration/test_middleware_consistency.py -v --tb=short

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        run: |
          pytest tests/integration/ --cov=agenkit --cov-report=xml -k "not slow and not skip"

  go-integration:
    name: Go Integration Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ["1.21", "1.22"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Run Go integration tests
        working-directory: ./agenkit-go
        run: |
          go test ./tests/integration -v -race

  cross-language:
    name: Cross-Language Integration Tests
    runs-on: ubuntu-latest
    needs: [python-integration, go-integration]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-asyncio

      - name: Start Go test server (HTTP)
        working-directory: ./agenkit-go
        run: |
          go run tests/integration/cmd/test_server.go -port 8090 &
          sleep 2

      - name: Run Python→Go HTTP tests
        run: |
          pytest tests/integration/test_http_transport.py::test_python_to_go_http -v || true

      - name: Stop Go server
        run: |
          pkill -f test_server.go || true

  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [python-integration, go-integration]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "Python Integration Tests: ${{ needs.python-integration.result }}"
          echo "Go Integration Tests: ${{ needs.go-integration.result }}"

          if [ "${{ needs.python-integration.result }}" != "success" ] || [ "${{ needs.go-integration.result }}" != "success" ]; then
            echo "❌ Integration tests failed"
            exit 1
          else
            echo "✅ All integration tests passed"
          fi
